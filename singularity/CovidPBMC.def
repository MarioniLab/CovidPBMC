Bootstrap: docker
From: ubuntu

%help
This Singularity container contains all the software necessary to reproduce the analysis of PBMCs from Covid19 patients.

%files
    /home/karsten/Cambridge/CovidPBMC/singularity/InstallPackages.R /Install.R
    /home/karsten/Cambridge/CovidPBMC/singularity/ListOfPackages.txt /ListOfPackages.txt
    /home/karsten/Cambridge/CovidPBMC/singularity/cellranger-3.1.0.tar.gz /cellranger-3.1.0.tar.gz

%post
   apt-get -y update
   apt-get -y install git curl wget rsync

   #tzdata without interactive mode otherwise it crashes
   #set noninteractive installation
   export DEBIAN_FRONTEND=noninteractive
   #install tzdata package
   apt-get install -y tzdata

   #needed for R package install
   apt-get -y install libcurl4-openssl-dev libxml2-dev libssl-dev libudunits2-dev

   #for r markdown documents
   apt-get -y install pandoc imagemagick pandoc-citeproc

   #R installation requires fortran compiler
   apt-get -y install gcc-7 gfortran-7 #g++-7

   #reqs for some of the packages
   apt-get -y install  libpcre3-dev

   #for h5
   apt-get -y install libhdf5-dev libhdf5-cpp-100 libhdf5-100

   #ubuntu 18.04 specific issue for apt-get build-dep, this is required to build R from source
   sed -Ei 's/^# deb-src /deb-src /' /etc/apt/sources.list
   apt-get update
   apt-get -y build-dep r-base r-base-dev

   #install R 
   cd /
   wget https://cran.r-project.org/src/base/R-3/R-3.6.3.tar.gz
   tar -xzf R-3.6.3.tar.gz
   cd R-3.6.3
   sh ./tools/rsync-recommended
   ./configure && make && make install
   cd /

   #install CellRanger
   tar -xzf cellranger-3.1.0.tar.gz

   #Set R_LIBS 
   echo "R_LIBS=/usr/local/lib/R/library" > /usr/local/lib/R/etc/Renviron.site


   #Install R packages
   Rscript /Install.R

%environment
   #Setup Path
   PATH="/cellranger-3.1.0/:$PATH"
   export PATH
